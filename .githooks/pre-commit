#!/usr/bin/env bash
set -euo pipefail

export PATH="/opt/homebrew/bin:/usr/local/bin:${PATH:-/usr/bin:/bin:/usr/sbin:/sbin}"

if [[ "${SKIP_GITLEAKS:-0}" == "1" ]]; then
  echo "[gitleaks] SKIP_GITLEAKS=1 set; skipping secret scan."
  exit 0
fi

GITLEAKS_BIN="$(command -v gitleaks || true)"
if [[ -z "${GITLEAKS_BIN}" ]]; then
  for candidate in "/opt/homebrew/bin/gitleaks" "/usr/local/bin/gitleaks" "${HOME}/bin/gitleaks"; do
    if [[ -x "${candidate}" ]]; then
      GITLEAKS_BIN="${candidate}"
      break
    fi
  done
fi

if [[ -z "${GITLEAKS_BIN}" ]]; then
  cat <<'MSG'
[gitleaks] gitleaks is required to commit.
Install it first, then retry:
  - macOS (Homebrew): brew install gitleaks
  - Linux (binary): https://github.com/gitleaks/gitleaks/releases
To bypass one commit (not recommended), run:
  SKIP_GITLEAKS=1 git commit ...
MSG
  exit 1
fi

echo "[gitleaks] scanning staged changes..."
if "${GITLEAKS_BIN}" help protect >/dev/null 2>&1; then
  "${GITLEAKS_BIN}" protect --staged --redact --verbose
else
  # Fallback for older gitleaks versions without `protect`.
  # Scan only staged content by piping the staged diff to stdin mode.
  git diff --cached --no-color | "${GITLEAKS_BIN}" stdin --redact --verbose
fi
